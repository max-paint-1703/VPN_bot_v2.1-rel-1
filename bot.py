import os
import shutil
import logging
from datetime import datetime
from dotenv import load_dotenv
from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup
)
from telegram.ext import (
    Application,
    CommandHandler,
    ContextTypes,
    MessageHandler,
    filters,
    CallbackQueryHandler,
    ConversationHandler
)
import database as db

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
load_dotenv()
TOKEN = os.getenv('TOKEN')
ADMIN_ID = int(os.getenv('ADMIN_ID'))

# ĞŸÑƒÑ‚Ğ¸ Ğº Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ÑĞ¼
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
AVAILABLE_DIR = os.path.join(BASE_DIR, 'configs', 'available')
USED_DIR = os.path.join(BASE_DIR, 'configs', 'used')
LOG_FILE = os.path.join(BASE_DIR, 'data', 'bot.log')

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    filename=LOG_FILE
)
logger = logging.getLogger(__name__)

# Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ´Ğ»Ñ ConversationHandler
FIO, ORG = range(2)

# Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
pending_requests = {}
list_state = {}

def check_configs():
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ²"""
    if not os.path.exists(AVAILABLE_DIR):
        os.makedirs(AVAILABLE_DIR)
    if not os.path.exists(USED_DIR):
        os.makedirs(USED_DIR)
    
    configs = [f for f in os.listdir(AVAILABLE_DIR) if f.endswith('.conf')]
    logger.info(f"Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ²: {len(configs)}")
    return configs

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start"""
    user = update.message.from_user
    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user.id} Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ» Ğ±Ğ¾Ñ‚Ğ°")
    
    keyboard = [[InlineKeyboardButton("ğŸ”‘ Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³", callback_data='request_config')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        f"ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {user.first_name}!\n"
        "Ğ¯ Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¹ WireGuard VPN\n\n"
        "âš ï¸ Ğ”Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ±Ğ¾Ñ‚Ğ° Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾:\n"
        "1. ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚ ÑĞ¾ Ğ¼Ğ½Ğ¾Ğ¹ (@KaratVpn_bot)\n"
        "2. ĞĞµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°",
        reply_markup=reply_markup
    )

async def request_config(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° (Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /get)"""
    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        user = query.from_user
        await query.edit_message_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¤Ğ˜Ğ:")
    else:
        user = update.message.from_user
        await update.message.reply_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¤Ğ˜Ğ:")
    
    return FIO

async def get_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /get"""
    return await request_config(update, context)

async def get_fio(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¤Ğ˜Ğ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    user = update.message.from_user
    context.user_data['full_name'] = update.message.text
    await update.message.reply_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆÑƒ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:")
    return ORG

async def get_org(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ"""
    user = update.message.from_user
    organization = update.message.text
    full_name = context.user_data['full_name']
    
    configs = check_configs()
    if not configs:
        await update.message.reply_text("âš ï¸ Ğ’ÑĞµ ĞºĞ»ÑÑ‡Ğ¸ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ¸ÑÑŒ. ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½.")
        await notify_admin(context, "âš ï¸ Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•! Ğ—Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ¸ÑÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸!")
        return ConversationHandler.END
    
    config_file = configs[0]
    pending_requests[user.id] = {
        'config_file': config_file,
        'full_name': full_name,
        'organization': organization
    }
    
    username = f"@{user.username}" if user.username else "Ğ½ĞµÑ‚ username"
    request_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    admin_message = (
        f"ğŸ†• ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°:\n"
        f"ğŸ‘¤ Ğ˜Ğ¼Ñ: {user.full_name}\n"
        f"ğŸ“Œ Username: {username}\n"
        f"ğŸ†” ID: {user.id}\n"
        f"ğŸ¢ ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: {organization}\n"
        f"ğŸ‘¨â€ğŸ’¼ Ğ¤Ğ˜Ğ: {full_name}\n"
        f"ğŸ•’ Ğ’Ñ€ĞµĞ¼Ñ: {request_time}\n"
        f"ğŸ“ Ğ¤Ğ°Ğ¹Ğ»: {config_file}"
    )
    
    keyboard = [
        [InlineKeyboardButton("âœ… ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ", callback_data=f"approve_{user.id}"),
         InlineKeyboardButton("âŒ ĞÑ‚ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ", callback_data=f"reject_{user.id}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await context.bot.send_message(
            chat_id=ADMIN_ID,
            text=admin_message,
            reply_markup=reply_markup
        )
        await update.message.reply_text("âœ… Ğ’Ğ°Ñˆ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ. ĞĞ¶Ğ¸Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ: {e}")
        await update.message.reply_text("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.")
    
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°"""
    await update.message.reply_text("Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½.")
    return ConversationHandler.END

async def handle_admin_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    query = update.callback_query
    await query.answer()
    
    try:
        data_parts = query.data.split('_')
        action = data_parts[0]
        user_id = int(data_parts[1])
        
        request_data = pending_requests.get(user_id)
        if not request_data:
            await query.message.reply_text("âš ï¸ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½")
            return
        
        config_file = request_data['config_file']
        full_name = request_data['full_name']
        organization = request_data['organization']
        
        if action == "approve":
            src_path = os.path.join(AVAILABLE_DIR, config_file)
            dest_path = os.path.join(USED_DIR, config_file)
            
            try:
                # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
                await context.bot.send_document(
                    chat_id=user_id,
                    document=open(src_path, 'rb'),
                    caption=f"âœ… Ğ’Ğ°Ñˆ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³: {config_file}"
                )
                shutil.move(src_path, dest_path)
                
                # Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
                user_data = await context.bot.get_chat(user_id)
                username = user_data.username if user_data.username else None
                db.add_issued_config(user_id, username, full_name, organization, config_file)
                
                # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
                await query.message.reply_text(
                    f"âœ… ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ {config_file} Ğ²Ñ‹Ğ´Ğ°Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ID: {user_id}\n"
                    f"ğŸ‘¤ Ğ¤Ğ˜Ğ: {full_name}\n"
                    f"ğŸ¢ ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: {organization}"
                )
            except Exception as e:
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° {user_id}: {e}")
                await query.message.reply_text(f"ğŸš« ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°: {e}")
            finally:
                if user_id in pending_requests:
                    del pending_requests[user_id]
        
        elif action == "reject":
            try:
                await context.bot.send_message(
                    chat_id=user_id,
                    text="âŒ Ğ’Ğ°Ñˆ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ñ‘Ğ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼"
                )
            except Exception as e:
                logger.error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_id}: {e}")
            
            await query.message.reply_text(f"âŒ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ID: {user_id} Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ñ‘Ğ½")
            if user_id in pending_requests:
                del pending_requests[user_id]
    
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ callback: {e}")
        await query.message.reply_text("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°")

async def list_issued(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° ÑĞ¿Ğ¸ÑĞºĞ° Ğ²Ñ‹Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ²"""
    if update.message.from_user.id != ADMIN_ID:
        await update.message.reply_text("âš ï¸ Ğ­Ñ‚Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ")
        return
    
    # Ğ¡Ğ±Ñ€Ğ¾Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
    context.user_data['list_page'] = 0
    await show_list_page(update, context)

async def show_list_page(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ ÑĞ¿Ğ¸ÑĞºĞ°"""
    page = context.user_data.get('list_page', 0)
    limit = 5
    offset = page * limit
    
    configs = db.get_issued_configs(limit, offset)
    total_count = db.count_issued_configs()
    
    if not configs and page == 0:
        await update.message.reply_text("ğŸ“­ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²Ñ‹Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² Ğ¿ÑƒÑÑ‚")
        return
    
    message = f"ğŸ“‹ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²Ñ‹Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² (ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {page + 1}):\n\n"
    for i, config in enumerate(configs, start=1):
        record_id, user_id, username, full_name, organization, config_file, issue_time, issue_type = config
        message += (
            f"ğŸ”¹ #{record_id}\n"
            f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: @{username or 'N/A'} (ID: {user_id})\n"
            f"ğŸ‘¨â€ğŸ’¼ Ğ¤Ğ˜Ğ: {full_name}\n"
            f"ğŸ¢ ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: {organization}\n"
            f"ğŸ”‘ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³: {config_file}\n"
            f"ğŸ•’ Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸: {issue_time}\n"
            f"âš¡ï¸ Ğ¢Ğ¸Ğ¿: {'Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ°' if issue_type == 'fast' else 'Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ°Ñ'}\n\n"
        )
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    keyboard = []
    
    # ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"
    if configs:
        keyboard.append([InlineKeyboardButton("âŒ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ", callback_data="delete_record")])
    
    # ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    nav_buttons = []
    if page > 0:
        nav_buttons.append(InlineKeyboardButton("â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="list_prev"))
    if offset + limit < total_count:
        nav_buttons.append(InlineKeyboardButton("Ğ’Ğ¿ĞµÑ€ĞµĞ´ â¡ï¸", callback_data="list_next"))
    
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(message, reply_markup=reply_markup)

async def handle_list_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ"""
    query = update.callback_query
    await query.answer()
    
    action = query.data
    page = context.user_data.get('list_page', 0)
    
    if action == "list_prev":
        context.user_data['list_page'] = max(0, page - 1)
    elif action == "list_next":
        context.user_data['list_page'] = page + 1
    elif action == "delete_record":
        await query.message.reply_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ID Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ:")
        context.user_data['awaiting_delete_id'] = True
        return
    
    await show_list_page(update, context)

async def handle_delete_record(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸"""
    if not context.user_data.get('awaiting_delete_id', False):
        return
    
    try:
        record_id = int(update.message.text)
        config_data = db.get_issued_config_by_id(record_id)
        
        if not config_data:
            await update.message.reply_text("âš ï¸ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ ID Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°")
            return
        
        db.delete_issued_config(record_id)
        await update.message.reply_text(f"âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ #{record_id} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°")
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº
        context.user_data['awaiting_delete_id'] = False
        await show_list_page(update, context)
    except ValueError:
        await update.message.reply_text("âš ï¸ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğ¹ ID Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸")

async def get_fast(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ¡ĞºÑ€Ñ‹Ñ‚Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° Ğ±ĞµĞ· Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸"""
    user = update.message.from_user
    logger.info(f"Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑˆĞµĞ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ {user.id} Ñ‡ĞµÑ€ĞµĞ· /getfast")
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ‡Ğ°Ñ‚Ğ°
    try:
        await context.bot.send_chat_action(chat_id=user.id, action='typing')
    except Exception as e:
        logger.error(f"Ğ§Ğ°Ñ‚ Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ {user.id} Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½: {e}")
        await update.message.reply_text("âš ï¸ Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼.")
        return
    
    configs = check_configs()
    if not configs:
        await update.message.reply_text("âš ï¸ Ğ’ÑĞµ ĞºĞ»ÑÑ‡Ğ¸ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ¸ÑÑŒ!")
        return
    
    config_file = configs[0]
    src_path = os.path.join(AVAILABLE_DIR, config_file)
    dest_path = os.path.join(USED_DIR, config_file)
    
    try:
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°
        with open(src_path, 'rb') as file:
            await context.bot.send_document(
                chat_id=user.id,
                document=file,
                caption=f"âš¡ï¸ Ğ’Ğ°Ñˆ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ (Ğ±Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ°): {config_file}"
            )
        
        # ĞŸĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
        shutil.move(src_path, dest_path)
        
        # Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        username = f"@{user.username}" if user.username else None
        db.add_issued_config(
            user.id, 
            username, 
            "Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ°", 
            "ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°", 
            config_file,
            issue_type="fast"
        )
        
        # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
        username_display = username if username else f"ID: {user.id}"
        await notify_admin(
            context, 
            f"âš¡ï¸ Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ /getfast!\n"
            f"ğŸ”‘ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³: {config_file}\n"
            f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {username_display}\n"
            f"ğŸ•’ Ğ’Ñ€ĞµĞ¼Ñ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        )
        
        await update.message.reply_text(
            f"âœ… ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ {config_file} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ²Ñ‹Ğ´Ğ°Ğ½!\n"
            "ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½ Ğ¾ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ."
        )
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸: {e}")
        await update.message.reply_text(
            "âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ."
        )

async def notify_admin(context: ContextTypes.DEFAULT_TYPE, message: str):
    """Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    try:
        await context.bot.send_message(
            chat_id=ADMIN_ID,
            text=message
        )
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°: {e}")

def main():
    """Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°"""
    application = Application.builder().token(TOKEN).build()
    
    # Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²
    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler('get_config', request_config),
            CommandHandler('get', get_command),  # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ»Ñ /get
            CallbackQueryHandler(request_config, pattern='^request_config$')
        ],
        states={
            FIO: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_fio)],
            ORG: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_org)]
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )
    
    application.add_handler(conv_handler)
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("list", list_issued))
    application.add_handler(CommandHandler("getfast", get_fast))  # Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº
    application.add_handler(CallbackQueryHandler(handle_admin_callback, pattern='^approve_|^reject_'))
    application.add_handler(CallbackQueryHandler(handle_list_callback, pattern='^list_|^delete_record'))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_delete_record))
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹
    configs = check_configs()
    if not configs:
        logger.warning("ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ²!")
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ context Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
        application.create_task(notify_admin(application, "âš ï¸ Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•! ĞĞ° ÑÑ‚Ğ°Ñ€Ñ‚Ğµ Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ²!"))
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
    logger.info("Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ...")
    application.run_polling()

if __name__ == "__main__":
    main()